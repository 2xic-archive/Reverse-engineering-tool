<!DOCTYPE html>
<html lang="en">
	<head>
		<title>reversing</title>
		<meta charset="utf-8"/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
		<!--
			testing with pako....
		!-->

		<!--
			https://github.com/NeXTs/Clusterize.js
		!-->
		<link href="clusterize/clusterize.css" rel="stylesheet">
		<script src="clusterize/clusterize.min.js"></script>

		<script type="text/javascript" src="pako.min.js"></script>

		<script src="cache.js"></script>
		<script src="benchmarker.js"></script>

		<script src="interface/backward_forward.js"></script>
		<script src="interface/highlighter.js"></script>
		<script src="interface/actions.js"></script>
		<script src="interface/search.js"></script>

		<script src="dynamic-view/dynamic-view.js"></script>
		<script src="flat-view/flat-view.js"></script>
		<script src="grapth-view/grapth.js"></script>
		<script src="grapth-view/grapth-view.js"></script>
		<script src="hex-view/hex-view.js"></script>

		<script src="./new_grapth/grapth.js"></script>
		

		<link rel="stylesheet" type="text/css" href="css/menubar.css">
		<link rel="stylesheet" type="text/css" href="css/flat-view.css">
		<link rel="stylesheet" type="text/css" href="css/index.css">
		<link rel="stylesheet" type="text/css" href="css/grapth-view.css">
		<link rel="stylesheet" type="text/css" href="css/section-serach.css">
	</head>

	<body>
		<!--
			menu
		!-->
		<div id="container_split">
			<div id="menu">
				<div>
					<ul>
						<li><button id="backward" disabled="">&larr;</button></li>
						<li><button id="forward" disabled>&rarr;</button></li>
						<li><button onclick="open_close_search()">Sections</button></li>
						<li><button disabled onclick="save_project()">Save</button></li>
						<li><button id="hex_hide" onclick="hide_hex()">#</button></li>
						<li><button id="grapth_hide" onclick="hide_grapth()">&#8258;</button></li>
					</ul>
					<div id="search_content" class="search_box" tabindex="2">
						<input type="text" autocomplete="off" placeholder="Search.." id="search" onkeyup="filter_search()">
					</div>
				</div>
			</div>

			<div id="menu">
				<!--
					maybe add a image of the binary structure or something...
				!-->
			</div>

			<div id="container">
				<div id="container_row">
					<!--
					<div id="container_item_70" name="flat-view-div"  class="clusterize">
					!-->

						<!--    flat-view   !-->
						<!--
						<table id="flat_view_table">
							<tr id="table_header">
								<th>address</th>
								<th>code</th>
								<th>comment</th>
							</tr>
						</table>
						!-->
						<!--
							  <table>
							    <thead>
							      <tr>
							        <th>address</th>
									<th>code</th>
									<th>comment</th>
							      </tr>
							    </thead>
							  </table>

							  <div id="instruction_scroll" class="clusterize-scroll">
							    <table>
							      <tbody id="instruction_content" class="clusterize-content">
							        <tr class="clusterize-no-data">
							          <td>Loading data…</td>
							        </tr>
							      </tbody>
							    </table>
							  </div>
							!-->

							<div class="clusterize">
							<!--
							  <table>
							    <thead>
							       <tr>
							        <th>address</th>
									<th>code</th>
									<th>comment</th>
							      </tr>
							    </thead>
							  </table>
							 !-->
							  <div id="scrollArea" class="clusterize-scroll">
							    <table>
							      <tbody id="contentArea" class="clusterize-content">
							        <tr class="clusterize-no-data">
							          <td>Loading data…</td>
							        </tr>
							      </tbody>
							    </table>
							  </div>
							</div>
					<!--
					</div>
					!-->
					<!--
					<div name="hex_view" id="container_item_30">
						<div id="container_item_50">
							
							<div id="container_full" class="clusterize">
									<table>
										<thead>


										</thead>
								</table>

								<div id="hex_scroll" class="clusterize-scroll">
								    <table>
								      <tbody id="hex_area" class="clusterize-content">
								        <tr class="clusterize-no-data">
								          <td>Loading data…</td>
								        </tr>
								      </tbody>
								    </table>
								  </div>
							</div>
							<div id="container_full">
								<table>
										<thead>

								</thead>
								</table>

								<div id="char_scroll" class="clusterize-scroll">
								    <table id="char_table">
								      <tbody id="char_area" class="clusterize-content">
								        <tr class="clusterize-no-data">
								          <td>Loading data…</td>
								        </tr>
								      </tbody>
								    </table>
								  </div>
							</div>							
						</div>
					</div>
					!-->
					
				</div>

				<!--    Grapth-view !-->        
				<div id="container_row">
					<div id="container_item_70" name="grapth-div">
						<div id="grapth" >
							<canvas id="canvas">
								<!--    will be drawn   !-->
							</canvas>
						</div>
					</div>
					<div id="container_item_30" name="dynamic_div">
						<center>
							<h1>Unicorn data here</h1>						
						</center>
					</div>
				</div>
			</div>
		</div>


		<script type="text/javascript">
			var socket = io.connect('http://' + document.domain + ':' + location.port);
			var benchmark = false;
			var code_lookup = undefined;

			if(!benchmark){
				socket.on('connect', function() {
					socket.emit('online');
				});

				socket.on('error', function(msg){
					if(msg.indexOf("xhr") == -1){
						alert(msg);
					}
				});

				socket.on('dynamic_data', function(msg){
					create_dynamic_view(msg);
				});

				socket.on('block', function(msg){
					code_sections = msg["sections"];
					code_lookup = msg["code"];

					var data = create_flat_view(msg["code"]);
					/*
					create_blocks(msg["grapth"]);
					if(last_message == undefined){
						create_grapth(msg["grapth"], 0, false);
					}else{
						create_grapth(msg["grapth"], 0, true);
					}
					*/
					var clusterize = new Clusterize({
						rows: data,
						scrollId: 'scrollArea',
						contentId: 'contentArea'
					});
					
					socket.emit('give_grapth');

				});

				socket.on('draw', function(msg) {
					//console.log(msg);

					var ctx = setup_canvas(1280, 800);


					var grapth = msg["layout"];
					var code_hint = msg["code"];

					var padding_top = 100;
					var padding_left = 100;
					var space_between_nodes = 50;

					var nodes = Object.keys(grapth);

					//	you process one level
					//	then you check the highest node, that node will have the y of next level + padding

					console.log(code_hint);
					var last_heigth_max = 0;
					for (var level = 0; level < nodes.length; level++) {
						var max = 0;
						for (var node = 0; node < grapth[level].length; node++) {
							var drawn_size = create_node(padding_left + grapth[level][node][1], padding_top + last_heigth_max + grapth[level][node][2], grapth[level][node][0], code_hint[grapth[level][node][0]] );
							drawn_size.setAttribute("id", grapth[level][node][0]);
							var offsetHeight = drawn_size.offsetHeight;
							max = Math.max(max, offsetHeight);
							console.log(offsetHeight);
						}
						last_heigth_max += (max + space_between_nodes);
					}

					var edges = msg["edges"];
					var head_edges = Object.keys(edges);

					var delta = document.getElementsByName("grapth-div")[0].getBoundingClientRect();

					for (var i = 0; i < head_edges.length; i++) {
						var working_head = head_edges[i];
						console.log(working_head);

						var head = document.getElementById(working_head);
						var xy = head.getBoundingClientRect();

						/*
							-	5 is for the border size
						*/
						var x0 = (xy.left + (xy.width) / 2) - delta.left;
						var y0 = (xy.top + xy.height - 5) - delta.top;

						for (var j = 0; j < edges[working_head].length; j++) {
							var edge_id = edges[working_head][j];
							var edge_xy = document.getElementById(edge_id).getBoundingClientRect();
							var x1 = (edge_xy.left + (edge_xy.width) / 2) - delta.left;
							var y1 = (edge_xy.top) - delta.top;

							ctx.beginPath();
							ctx.strokeStyle = "red";
							ctx.moveTo(x0, y0);

							if (x0 < x1) {
								ctx.quadraticCurveTo(x0 + 50, y0, x1, y1);
							} else {
								ctx.quadraticCurveTo(x0 - 50, y0, x1, y1);
							}
							ctx.stroke();
						}
						console.log("");
						break;
					}
				});

				/*
				socket.on('hex_response', function(msg){
					if(msg != null && msg["data"] != null){
						create_hex_view(msg["data"]);
					}
				});*/
			}else{
				load_view_cache();
			}
		</script>
	</body>
</html>
