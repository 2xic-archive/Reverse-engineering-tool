<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>



	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
	<script src="./grapth.js"></script>
	
	<style type="text/css">
		
		#grapth{
			min-height: 500px;
			min-width: 500px;
			border-style: solid;
		}	

		.node{
			border-style: solid;
			display: inline-block;
	/*		top:150px;
			left:100px;*/
			min-width: 300px;
			max-width: 300px;
/*			min-height: 100px;
			max-height: 100px;*/
			margin: 0px;
			padding: 0px;
			position: absolute;
			overflow: scroll;
		}


	</style>


	<div id="grapth">
		<canvas id="canvas">
			<!--    will be drawn   !-->
		</canvas>
	</div>

	<script type="text/javascript">
				//	you know the section name , you have all this data sent already over the socket
		var code = {"section_name": ".init", "code": {"0x400480": {"instruction": "sub", "argument": "rsp, 8", "registers": ["rsp", "rflags"], "address_int": 4195456, "comment": ""}, "0x400484": {"instruction": "mov", "argument": "rax, qword ptr [rip + 0x200b6d]", "registers": ["rip", "rax"], "address_int": 4195460, "comment": "__gmon_start__"}, "0x40048b": {"instruction": "test", "argument": "rax, rax", "registers": ["rflags", "rax"], "address_int": 4195467, "comment": ""}, "0x40048e": {"instruction": "je", "argument": "0x400492", "registers": ["rflags"], "address_int": 4195470, "comment": ""}, "0x400490": {"instruction": "call", "argument": "rax", "registers": ["rsp", "rax"], "address_int": 4195472, "comment": ""}, "0x400492": {"instruction": "add", "argument": "rsp, 8", "registers": ["rsp", "rflags"], "address_int": 4195474, "comment": ""}, "0x400496": {"instruction": "ret", "argument": "", "registers": ["rsp"], "address_int": 4195478, "comment": ""}}, "registers": []};


		var socket = io.connect('http://' + document.domain + ':' + location.port);
		socket.on('connect', function() {
			socket.emit('online')
		});

		socket.on('draw', function(msg) {
			//console.log(msg);

			var ctx = setup_canvas(1280, 800);


			var grapth = msg["layout"];
			var code_hint = msg["code"];

			var padding_top = 100;
			var padding_left = 100;
			var space_between_nodes = 50;

			var nodes = Object.keys(grapth);

			//	you process one level
			//	then you check the highest node, that node will have the y of next level + padding
			var last_heigth_max = 0;
			for (var level = 0; level < nodes.length; level++) {
				var max = 0;
				for (var node = 0; node < grapth[level].length; node++) {
					var drawn_size = create_node(padding_left + grapth[level][node][1], padding_top + last_heigth_max + grapth[level][node][2], grapth[level][node][0], code_hint[grapth[level][node][0]]);
					drawn_size.setAttribute("id", grapth[level][node][0]);
					var offsetHeight = drawn_size.offsetHeight;
					max = Math.max(max, offsetHeight);
					console.log(offsetHeight);
				}
				last_heigth_max += (max + space_between_nodes);
			}

			var edges = msg["edges"];
			var head_edges = Object.keys(edges);
			for (var i = 0; i < head_edges.length; i++) {
				var working_head = head_edges[i];
				console.log(working_head);

				var head = document.getElementById(working_head);
				if(head == null){
					continue;
				}

				var xy = head.getBoundingClientRect();

				/*
					-	10 is for the border size
				*/
				var x0 = xy.left + (xy.width) / 2;
				var y0 = xy.top + xy.height - 10;

				for (var j = 0; j < edges[working_head].length; j++) {
					var edge_id = edges[working_head][j];
					var edge_xy = document.getElementById(edge_id).getBoundingClientRect();
					var x1 = edge_xy.left + (edge_xy.width) / 2;
					var y1 = edge_xy.top - 10;

					ctx.beginPath();
					ctx.strokeStyle = "red";
					ctx.moveTo(x0, y0);

					if (x0 < x1) {
						ctx.quadraticCurveTo(x0 + 50, y0, x1, y1);
					} else {
						ctx.quadraticCurveTo(x0 - 50, y0, x1, y1);
					}
					ctx.stroke();
				}
				console.log("");
				break;
			}
		});
	</script>
</body>
</html>







